<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGuayllabamba - Geoportal para la gesti√≥n ambiental</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Bot√≥n para mostrar/ocultar panel en m√≥viles -->
    <button class="mobile-toggle-panel" id="mobile-toggle-btn" title="Mostrar/Ocultar Panel">‚ò∞</button>
    
    <div id="map"></div>
    
    <div class="control-panel">
        <!-- Encabezado del Panel -->
        <div class="control-panel-title">
            <h2>üåø EcoGuayllabamba</h2>
            <p>Gesti√≥n Ambiental y Mitigaci√≥n del Riesgo</p>
        </div>
        
        <div class="control-section">
            <div class="control-panel-header" onclick="toggleBasemapPanel()">
                <h3>üó∫Ô∏è Mapa Base</h3>
                <span class="toggle-icon" id="basemap-toggle-icon">‚ñº</span>
            </div>
            <div class="control-panel-content" id="basemap-content">
                <div style="padding: 10px 0;">
                    <label style="display: block; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 6px;">
                        <input type="radio" name="basemap" value="street" checked style="margin-right: 8px;">
                        üèôÔ∏è Street Map
                    </label>
                    <label style="display: block; cursor: pointer; padding: 8px; border-radius: 6px;">
                        <input type="radio" name="basemap" value="satellite" style="margin-right: 8px;">
                        üõ∞Ô∏è Satellite
                    </label>
                </div>
            </div>
        </div>
        
        <div class="control-section">
            <div class="control-panel-header" onclick="toggleLayerPanel()">
                <h3>üìä Capas Disponibles</h3>
                <span class="toggle-icon" id="toggle-icon">‚ñº</span>
            </div>
            <div class="control-panel-content" id="layer-controls"></div>
        </div>
        
        <div class="analysis-control">
            <div class="analysis-control-header" onclick="toggleAnalysisPanel()">
                <h3>üéØ Definir cruce con √°reas sensibles</h3>
                <span class="toggle-icon" id="analysis-toggle-icon">‚ñº</span>
            </div>
            <div class="analysis-control-content" id="analysis-content">
                <button class="btn-primary" id="analysis-btn">üìç Seleccionar punto</button>
            </div>
        </div>
        
        <div class="analysis-control">
            <div class="analysis-control-header" onclick="toggleCitizenReportPanel()">
                <h3>üìù Reporte Ciudadano</h3>
                <span class="toggle-icon" id="citizen-report-toggle-icon">‚ñº</span>
            </div>
            <div class="analysis-control-content" id="citizen-report-content">
                <div id="citizen-report-form" class="citizen-report-form">
                    <div class="form-group">
                        <label>Tipo de reporte: *</label>
                        <select id="report-type">
                            <option value="">Seleccione...</option>
                            <option value="escombros">Mala disposici√≥n de escombros</option>
                            <option value="deforestacion">Deforestaci√≥n</option>
                            <option value="incendio">Incendio</option>
                            <option value="deslizamiento">Deslizamiento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n: *</label>
                        <textarea id="report-description" placeholder="Describa la situaci√≥n observada..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Nombre completo: *</label>
                        <input type="text" id="report-name" placeholder="Ej: Juan Carlos P√©rez Gonz√°lez">
                        <small id="name-feedback" style="display:block; margin-top:5px; font-size:11px; color:#6c757d;"></small>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="get-location-btn">üìç Obtener mi ubicaci√≥n</button>
                    </div>
                    <div id="location-selected" style="display:none; margin-top:10px; padding:10px; background:#d4edda; border-radius:3px; font-size:12px;">
                        ‚úì Ubicaci√≥n seleccionada
                    </div>
                    <div class="form-group">
                        <div class="captcha-box">
                            <div class="captcha-question" id="captcha-question"></div>
                            <input type="number" id="captcha-answer" placeholder="Ingrese su respuesta">
                        </div>
                    </div>
                    <div id="form-validation-message" style="display:none; margin:10px 0; padding:10px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:3px; font-size:12px;">
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="submit-report-btn" disabled>Enviar Reporte</button>
                        <button class="btn-secondary" id="cancel-report-btn">Cancelar</button>
                    </div>
                </div>
                <div id="citizen-reports-list" class="citizen-reports-list" style="display:none;">
                    <div id="reports-container"></div>
                    <div id="total-reports" style="margin-top:15px; padding:10px; background:#f8f9fa; border-radius:3px; text-align:center; font-size:12px; color:#6c757d;"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn-primary" style="flex:1;" id="new-report-btn">Nuevo Reporte</button>
                        <button class="btn-secondary" style="flex:1;" id="close-reports-btn">Cerrar</button>
                    </div>
                </div>
                <div style="padding:15px; text-align:center;">
                    <button class="btn-secondary" style="width:100%;" id="toggle-reports-view-btn">Ver Reportes</button>
                </div>
            </div>
        </div>
        
        <div class="analysis-control">
            <div class="analysis-control-header" onclick="toggleWasteManagementPanel()">
                <h3>‚ôªÔ∏è Gesti√≥n de escombros y reciclables</h3>
                <span class="toggle-icon" id="waste-management-toggle-icon">‚ñº</span>
            </div>
            <div class="analysis-control-content" id="waste-management-content">
                <!-- Sub-panel 1: Compra de reciclables -->
                <div class="control-section">
                    <div class="control-panel-header" onclick="toggleRecyclingPurchasePanel()">
                        <h4 style="margin:0; font-size:14px; color:#2c3e50;">üì¶ Compra de reciclables</h4>
                        <span class="toggle-icon" id="recycling-purchase-toggle-icon">‚ñº</span>
                    </div>
                    <div class="control-panel-content" id="recycling-purchase-content">
                        <div class="form-group">
                            <label>Nombre del punto: *</label>
                            <input type="text" id="recycling-name" placeholder="Ingrese nombre del punto de compra">
                        </div>
                        <div class="form-group">
                            <label>Tipo de residuos que compra: *</label>
                            <div style="margin-top:8px;">
                                <div class="waste-checkbox-label">
                                    <input type="checkbox" id="waste-papel" value="Papel">
                                    <span>Papel</span>
                                </div>
                                <div class="waste-checkbox-label">
                                    <input type="checkbox" id="waste-carton" value="Cart√≥n">
                                    <span>Cart√≥n</span>
                                </div>
                                <div class="waste-checkbox-label">
                                    <input type="checkbox" id="waste-vidrio" value="Vidrio">
                                    <span>Vidrio</span>
                                </div>
                                <div class="waste-checkbox-label">
                                    <input type="checkbox" id="waste-plastico" value="Pl√°stico">
                                    <span>Pl√°stico</span>
                                </div>
                                <div class="waste-checkbox-label">
                                    <input type="checkbox" id="waste-metales" value="Metales">
                                    <span>Metales</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="recycling-get-location-btn">üìç Obtener mi ubicaci√≥n</button>
                        </div>
                        <div id="recycling-location-selected" style="display:none; margin-top:10px; padding:10px; background:#d4edda; border-radius:3px; font-size:12px;">
                            ‚úì Ubicaci√≥n seleccionada
                        </div>
                        <div class="form-actions" style="margin-top:15px;">
                            <button class="btn-primary" id="submit-recycling-btn" disabled>Registrar Punto</button>
                            <button class="btn-secondary" id="cancel-recycling-btn">Cancelar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-panel 2: Tengo residuos -->
                <div class="control-section">
                    <div class="control-panel-header" onclick="toggleWasteDisposalPanel()">
                        <h4 style="margin:0; font-size:14px; color:#2c3e50;">üóëÔ∏è Tengo residuos s√≥lidos o escombros</h4>
                        <span class="toggle-icon" id="waste-disposal-toggle-icon">‚ñº</span>
                    </div>
                    <div class="control-panel-content" id="waste-disposal-content">
                        <div class="form-group">
                            <label>Tipo de residuos: *</label>
                            <select id="waste-type-search">
                                <option value="">Seleccione...</option>
                                <option value="papel">papel</option>
                                <option value="cart√≥n">cart√≥n</option>
                                <option value="vidrio">vidrio</option>
                                <option value="pl√°stico">pl√°stico</option>
                                <option value="metales">metales</option>
                                <option value="escombros">escombros</option>
                                <option value="escombros y voluminosos">escombros y voluminosos</option>
                                <option value="residuos de aparatos el√©ctricos y electr√≥nicos de uso dom√©stico">residuos de aparatos el√©ctricos y electr√≥nicos de uso dom√©stico</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="waste-search-location-btn">üìç Obtener mi ubicaci√≥n</button>
                        </div>
                        <div id="waste-location-selected" style="display:none; margin-top:10px; padding:10px; background:#d4edda; border-radius:3px; font-size:12px;">
                            ‚úì Ubicaci√≥n obtenida
                        </div>
                        <div class="form-actions" style="margin-top:15px;">
                            <button class="btn-primary" id="search-waste-points-btn" disabled>Buscar puntos cercanos</button>
                            <button class="btn-secondary" id="cancel-waste-search-btn">Cancelar</button>
                        </div>
                        <div id="waste-results" style="display:none; margin-top:15px; padding:15px; background:#f8f9fa; border-radius:5px;">
                            <h5 style="margin:0 0 10px 0; font-size:13px; color:#2c3e50;">Puntos cercanos encontrados:</h5>
                            <div id="waste-results-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="result-popup" class="result-popup">
        <h3 id="result-title"></h3>
        <div id="result-content"></div>
        <button id="close-result-btn">Cerrar</button>
        <button id="print-report-btn">Imprimir Reporte</button>
    </div>
    
    <div id="print-report" class="print-report"></div>
    
    <div id="info-overlay" class="info-overlay"></div>
    <div id="info-popup" class="info-popup">
        <h3 id="info-title"></h3>
        <div id="info-content"></div>
        <button id="close-info-btn">Cerrar</button>
    </div>
    
    <div id="loading" class="loading" style="display:none;">Cargando capas...</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script>
        // Esperar a que Leaflet se cargue completamente
        window.addEventListener('load', function() {
            initMap();
        });

        function initMap() {
            const SUPABASE_URL = 'https://xpgikbagngfuipwzoeaq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwZ2lrYmFnbmdmdWlwd3pvZWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4Mzg3NjMsImV4cCI6MjA4MzQxNDc2M30.tXMZcF7ZVWhkTsFCRo-81OWTkXqgQZXQNFxnaBhwAwI';

            // Variables globales para el an√°lisis
            let analysisMode = false;
            let analysisMarker = null;
            let lastAnalysisData = null; // Para guardar datos del √∫ltimo an√°lisis
            
            // Variables para reportes ciudadanos
            let reportLocationMode = false;
            let reportMarker = null;
            let reportLocation = null;
            let citizenReports = [];
            let reportMarkers = [];
            let captchaAnswer = 0;

            // Generar pregunta de captcha
            function generateCaptcha() {
                const num1 = Math.floor(Math.random() * 10) + 1;
                const num2 = Math.floor(Math.random() * 10) + 1;
                captchaAnswer = num1 + num2;
                document.getElementById('captcha-question').textContent = 
                    `Verificaci√≥n: ¬øCu√°nto es ${num1} + ${num2}?`;
            }

            // Informaci√≥n de las capas
            const layerInfo = {
                'area_protegida': {
                    nombre: '√Åreas Protegidas',
                    descripcion: 'Espacios geogr√°ficos claramente definidos, reconocidos y gestionados, mediante medios legales u otros tipos de medios eficaces para conseguir la conservaci√≥n a largo plazo de la naturaleza y de sus servicios ecosist√©micos y sus valores culturales asociados.',
                    fuente: 'Ministerio del Ambiente y Energ√≠a',
                    fecha: 'Octubre 2025'
                },
                'bosque_protector': {
                    nombre: 'Bosques Protectores',
                    descripcion: 'Espacios geogr√°ficos claramente definidos, reconocidos y gestionados, mediante medios legales u otros tipos de medios eficaces para conseguir la conservaci√≥n a largo plazo de la naturaleza y de sus servicios ecosist√©micos y sus valores culturales asociados.',
                    fuente: 'Ministerio del Ambiente y Energ√≠a',
                    fecha: 'Octubre 2025'
                },
                'area_urbana': {
                    nombre: '√Åreas Urbanas',
                    descripcion: '√Åreas urbanas delimitadas que representan zonas con desarrollo urbano consolidado, identificadas por la presencia continua de infraestructura, edificaciones y servicios.',
                    fuente: 'Instituto Geogr√°fico Militar, 2013, Base Continua Escala 1:50000',
                    fecha: 'Enero 2013 (√∫ltima actualizaci√≥n)'
                },
                'cuenca_guayllabamba': {
                    nombre: 'Cuenca del r√≠o Guayllabamba',
                    descripcion: 'Es la unidad territorial m√°s adecuada para la gesti√≥n de los recursos naturales en general y de los recursos h√≠dricos.',
                    fuente: 'Ministerio del Ambiente y Energ√≠a (Acuerdo No. 2017 ‚Äì 0023 del 15 de noviembre de 2017, Ex Secretar√≠a del Agua)',
                    fecha: 'Marzo 2025'
                },
                'deforestacion_20_22': {
                    nombre: 'Deforestaci√≥n 2020-2022',
                    descripcion: 'Es la diferencia entre la p√©rdida y ganancia de la superficie del bosque (deforestaci√≥n bruta menos regeneraci√≥n de bosque), en un periodo de tiempo.',
                    fuente: 'Ministerio del Ambiente y Energ√≠a',
                    fecha: 'Octubre 2023'
                },
                'punto_recoleccion_electronicos': {
                    nombre: 'Puntos Recolecci√≥n',
                    descripcion: 'Se detalla la ubicaci√≥n de los puntos de recolecci√≥n primaria, es decir, los sitios destinados para que el usuario final pueda entregar sus Residuos de Aparatos El√©ctricos y Electr√≥nicos (RAEE), acorde a lo dispuesto en el Acuerdo Ministerial 067, correspondiente al instructivo para la aplicaci√≥n de la REP en la gesti√≥n integral de RAEE de origen dom√©stico. Adem√°s, es actualizada por medio de registro de los usuarios de puntos de compra de materiales reciclables.',
                    fuente: 'Ministerio del Ambiente y Energ√≠a',
                    fecha: 'Noviembre 2024'
                }
            };

            // Inicializar mapa centrado en la zona de Cuenca Guayllabamba (norte de Quito)
            // Coordenadas ajustadas para cubrir un √°rea m√°s amplia que la cuenca
            const map = L.map('map').setView([-0.15, -78.45], 9);

            // Capas base
            const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            });
            
            const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });

            // Agregar capa base por defecto
            let currentBaseLayer = streetMap;
            currentBaseLayer.addTo(map);

            // Control de cambio de mapa base
            document.querySelectorAll('input[name="basemap"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    map.removeLayer(currentBaseLayer);
                    if (e.target.value === 'street') {
                        currentBaseLayer = streetMap;
                    } else {
                        currentBaseLayer = satelliteMap;
                    }
                    currentBaseLayer.addTo(map);
                });
            });

            // Definici√≥n de capas con estilos
            const layers = {
                'area_protegida': {
                    name: '√Åreas Protegidas',
                    style: { color: '#2ecc71', weight: 2, fillOpacity: 0.3 },
                    layer: null
                },
                'bosque_protector': {
                    name: 'Bosques Protectores',
                    style: { color: '#27ae60', weight: 2, fillOpacity: 0.3 },
                    layer: null
                },
                'area_urbana': {
                    name: '√Åreas Urbanas',
                    style: { color: '#e74c3c', weight: 1, fillOpacity: 0.4 },
                    layer: null
                },
                'cuenca_guayllabamba': {
                    name: 'Cuenca del r√≠o Guayllabamba',
                    style: { color: '#1abc9c', weight: 2, fillOpacity: 0.2 },
                    layer: null
                },
                'deforestacion_20_22': {
                    name: 'Deforestaci√≥n 2020-2022',
                    style: { color: '#e67e22', weight: 1, fillOpacity: 0.5 },
                    layer: null
                },
                'punto_recoleccion_electronicos': {
                    name: 'Puntos Recolecci√≥n',
                    style: { color: '#9b59b6', radius: 6, fillOpacity: 0.8 },
                    layer: null,
                    type: 'point'
                }
            };

            // Crear controles de capas
            const controlsDiv = document.getElementById('layer-controls');
            Object.keys(layers).forEach(layerId => {
                const div = document.createElement('div');
                div.className = 'layer-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = layerId;
                checkbox.onchange = () => toggleLayer(layerId);
                
                const label = document.createElement('label');
                label.htmlFor = layerId;
                label.textContent = layers[layerId].name;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                
                // Agregar bot√≥n de informaci√≥n si existe info para esta capa
                if (layerInfo[layerId]) {
                    const infoBtn = document.createElement('button');
                    infoBtn.className = 'info-btn';
                    infoBtn.textContent = '‚Ñπ';
                    infoBtn.title = 'Informaci√≥n de la capa';
                    infoBtn.onclick = (e) => {
                        e.stopPropagation();
                        showLayerInfo(layerId);
                    };
                    div.appendChild(infoBtn);
                }
                
                controlsDiv.appendChild(div);
            });

            // Cargar Cuenca Guayllabamba por defecto DESPU√âS de crear controles
            setTimeout(() => {
                loadLayer('cuenca_guayllabamba');
                document.getElementById('cuenca_guayllabamba').checked = true;
            }, 100);

            // Event listeners para cerrar popups de informaci√≥n
            document.getElementById('close-info-btn').addEventListener('click', () => {
                document.getElementById('info-overlay').style.display = 'none';
                document.getElementById('info-popup').style.display = 'none';
            });
            
            document.getElementById('info-overlay').addEventListener('click', () => {
                document.getElementById('info-overlay').style.display = 'none';
                document.getElementById('info-popup').style.display = 'none';
            });

            // Event listener para cerrar resultado
            document.getElementById('close-result-btn').addEventListener('click', () => {
                document.getElementById('result-popup').style.display = 'none';
                
                // Limpiar el contenedor de impresi√≥n
                document.getElementById('print-report').innerHTML = '';
                document.getElementById('print-report').style.display = 'none';
                
                // Desactivar el modo de an√°lisis
                if (analysisMode) {
                    analysisMode = false;
                    const analysisBtn = document.getElementById('analysis-btn');
                    analysisBtn.textContent = 'üìç Seleccionar punto';
                    analysisBtn.classList.remove('active');
                    
                    // Reactivar popups de todas las capas
                    Object.keys(layers).forEach(layerId => {
                        if (layers[layerId].layer) {
                            layers[layerId].layer.eachLayer(l => {
                                // Restaurar popup original
                                if (l._originalPopup) {
                                    l.bindPopup(l._originalPopup);
                                    delete l._originalPopup;
                                }
                                
                                // Restaurar popups en subcapas
                                if (l._layers) {
                                    Object.values(l._layers).forEach(sublayer => {
                                        if (sublayer._originalPopup) {
                                            sublayer.bindPopup(sublayer._originalPopup);
                                            delete sublayer._originalPopup;
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    const mapContainer = map.getContainer();
                    mapContainer.style.cursor = '';
                    mapContainer.classList.remove('analysis-cursor');
                    
                    // Remover el marcador si existe
                    if (analysisMarker) {
                        map.removeLayer(analysisMarker);
                        analysisMarker = null;
                    }
                }
            });

            // Event listener para imprimir reporte
            document.getElementById('print-report-btn').addEventListener('click', () => {
                console.log('Bot√≥n imprimir presionado, lastAnalysisData:', lastAnalysisData);
                printReport();
            });

            // Funcionalidad para m√≥viles
            if (window.innerWidth <= 768) {
                const panelTitle = document.querySelector('.control-panel-title');
                const controlPanel = document.querySelector('.control-panel');
                const mobileToggleBtn = document.getElementById('mobile-toggle-btn');
                
                // Click en t√≠tulo para minimizar/expandir
                if (panelTitle && controlPanel) {
                    panelTitle.addEventListener('click', function(e) {
                        // No hacer toggle si se hace click en el √°rea de minimizado completo
                        if (!controlPanel.classList.contains('mobile-hidden')) {
                            controlPanel.classList.toggle('minimized');
                        }
                    });
                    
                    // Iniciar minimizado en m√≥viles
                    controlPanel.classList.add('minimized');
                }
                
                // Bot√≥n para ocultar/mostrar panel completamente
                if (mobileToggleBtn && controlPanel) {
                    mobileToggleBtn.addEventListener('click', function() {
                        controlPanel.classList.toggle('mobile-hidden');
                        
                        // Cambiar √≠cono del bot√≥n
                        if (controlPanel.classList.contains('mobile-hidden')) {
                            mobileToggleBtn.textContent = '‚ò∞';
                        } else {
                            mobileToggleBtn.textContent = '‚úï';
                            // Al mostrar, mantener minimizado
                            controlPanel.classList.add('minimized');
                        }
                    });
                    
                    // Iniciar con panel oculto para m√°xima visualizaci√≥n del mapa
                    controlPanel.classList.add('mobile-hidden');
                    mobileToggleBtn.textContent = '‚ò∞';
                }
            }

            // Funci√≥n auxiliar para cerrar todos los paneles principales
            function closeAllMainPanels(exceptId = null) {
                const panels = [
                    { content: 'basemap-content', icon: 'basemap-toggle-icon' },
                    { content: 'layer-controls', icon: 'toggle-icon' },
                    { content: 'analysis-content', icon: 'analysis-toggle-icon' },
                    { content: 'citizen-report-content', icon: 'citizen-report-toggle-icon' },
                    { content: 'waste-management-content', icon: 'waste-management-toggle-icon' }
                ];
                
                panels.forEach(panel => {
                    if (panel.content !== exceptId) {
                        const content = document.getElementById(panel.content);
                        const icon = document.getElementById(panel.icon);
                        if (content && content.classList.contains('expanded')) {
                            content.classList.remove('expanded');
                            icon.classList.add('collapsed');
                        }
                    }
                });
            }

            // Funci√≥n para toggle del panel de capas
            window.toggleLayerPanel = function() {
                const content = document.getElementById('layer-controls');
                const icon = document.getElementById('toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllMainPanels('layer-controls');
                    
                    // En m√≥vil, expandir el panel principal
                    if (window.innerWidth <= 768) {
                        const controlPanel = document.querySelector('.control-panel');
                        if (controlPanel) {
                            controlPanel.classList.remove('minimized');
                        }
                    }
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Funci√≥n para toggle del panel de mapa base
            window.toggleBasemapPanel = function() {
                const content = document.getElementById('basemap-content');
                const icon = document.getElementById('basemap-toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllMainPanels('basemap-content');
                    
                    // En m√≥vil, expandir el panel principal
                    if (window.innerWidth <= 768) {
                        const controlPanel = document.querySelector('.control-panel');
                        if (controlPanel) {
                            controlPanel.classList.remove('minimized');
                        }
                    }
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Funci√≥n para toggle del panel de an√°lisis
            window.toggleAnalysisPanel = function() {
                const content = document.getElementById('analysis-content');
                const icon = document.getElementById('analysis-toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllMainPanels('analysis-content');
                    
                    // En m√≥vil, expandir el panel principal
                    if (window.innerWidth <= 768) {
                        const controlPanel = document.querySelector('.control-panel');
                        if (controlPanel) {
                            controlPanel.classList.remove('minimized');
                        }
                    }
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Funci√≥n para toggle del panel de reporte ciudadano
            window.toggleCitizenReportPanel = function() {
                const content = document.getElementById('citizen-report-content');
                const icon = document.getElementById('citizen-report-toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllMainPanels('citizen-report-content');
                    
                    // En m√≥vil, expandir el panel principal
                    if (window.innerWidth <= 768) {
                        const controlPanel = document.querySelector('.control-panel');
                        if (controlPanel) {
                            controlPanel.classList.remove('minimized');
                        }
                    }
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Funci√≥n para toggle del panel de gesti√≥n de residuos
            window.toggleWasteManagementPanel = function() {
                const content = document.getElementById('waste-management-content');
                const icon = document.getElementById('waste-management-toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllMainPanels('waste-management-content');
                    
                    // En m√≥vil, expandir el panel principal
                    if (window.innerWidth <= 768) {
                        const controlPanel = document.querySelector('.control-panel');
                        if (controlPanel) {
                            controlPanel.classList.remove('minimized');
                        }
                    }
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Funci√≥n auxiliar para cerrar todos los sub-paneles de residuos
            function closeAllWasteSubPanels(exceptId = null) {
                const subPanels = [
                    { content: 'recycling-purchase-content', icon: 'recycling-purchase-toggle-icon' },
                    { content: 'waste-disposal-content', icon: 'waste-disposal-toggle-icon' }
                ];
                
                subPanels.forEach(panel => {
                    if (panel.content !== exceptId) {
                        const content = document.getElementById(panel.content);
                        const icon = document.getElementById(panel.icon);
                        if (content && content.classList.contains('expanded')) {
                            content.classList.remove('expanded');
                            icon.classList.add('collapsed');
                        }
                    }
                });
            }

            // Funci√≥n para toggle del sub-panel de compra de reciclables
            window.toggleRecyclingPurchasePanel = function() {
                const content = document.getElementById('recycling-purchase-content');
                const icon = document.getElementById('recycling-purchase-toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllWasteSubPanels('recycling-purchase-content');
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Funci√≥n para toggle del sub-panel de tengo residuos
            window.toggleWasteDisposalPanel = function() {
                const content = document.getElementById('waste-disposal-content');
                const icon = document.getElementById('waste-disposal-toggle-icon');
                
                const isOpening = !content.classList.contains('expanded');
                if (isOpening) {
                    closeAllWasteSubPanels('waste-disposal-content');
                }
                
                content.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // ===== REPORTES CIUDADANOS =====
            
            // Cargar reportes desde Supabase
            async function loadCitizenReports() {
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/reportes_ciudadanos?select=*&order=fecha_reporte.desc`,
                        {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        citizenReports = await response.json();
                        console.log('Reportes cargados:', citizenReports.length);
                        displayReports();
                        showReportsOnMap();
                    } else {
                        console.error('Error cargando reportes');
                        citizenReports = [];
                    }
                } catch (e) {
                    console.error('Error al cargar reportes:', e);
                    citizenReports = [];
                }
            }

            // Mostrar reportes en el mapa
            function showReportsOnMap() {
                // Limpiar marcadores anteriores
                reportMarkers.forEach(m => map.removeLayer(m));
                reportMarkers = [];

                // Funci√≥n auxiliar para obtener color seg√∫n tipo
                const getTipoColor = (tipo) => {
                    const colores = {
                        'escombros': '#e67e22',      // Naranja
                        'deforestacion': '#27ae60',   // Verde oscuro
                        'incendio': '#e74c3c',        // Rojo
                        'deslizamiento': '#8e44ad'    // P√∫rpura
                    };
                    return colores[tipo] || '#95a5a6'; // Gris por defecto
                };

                // Funci√≥n auxiliar para obtener nombre completo del tipo
                const getTipoNombre = (tipo) => {
                    const nombres = {
                        'escombros': 'Mala disposici√≥n de escombros',
                        'deforestacion': 'Deforestaci√≥n',
                        'incendio': 'Incendio',
                        'deslizamiento': 'Deslizamiento'
                    };
                    return nombres[tipo] || 'Reporte';
                };

                // Agregar nuevos marcadores
                citizenReports.forEach(report => {
                    const marker = L.circleMarker([report.latitud, report.longitud], {
                        radius: 8,
                        fillColor: getTipoColor(report.tipo),
                        color: 'white',
                        weight: 2,
                        fillOpacity: 0.8
                    });

                    const popupContent = `
                        <strong>${getTipoNombre(report.tipo)}</strong><br>
                        <strong>Descripci√≥n:</strong> ${report.descripcion}<br>
                        ${report.nombre_reportante ? `<strong>Reportado por:</strong> ${report.nombre_reportante}<br>` : ''}
                        <strong>Fecha:</strong> ${new Date(report.fecha_reporte).toLocaleString('es-EC')}<br>
                        <strong>Estado:</strong> ${report.estado}
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                    reportMarkers.push(marker);
                });
            }

            // Mostrar lista de reportes
            function displayReports() {
                const container = document.getElementById('reports-container');
                const totalContainer = document.getElementById('total-reports');
                
                if (citizenReports.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#7f8c8d; font-size:12px;">No hay reportes a√∫n</p>';
                    totalContainer.innerHTML = '';
                    return;
                }

                // Mostrar solo los 3 √∫ltimos reportes
                const recentReports = citizenReports.slice(0, 3);
                
                // Funci√≥n auxiliar para obtener el icono y nombre del tipo
                const getTipoDisplay = (tipo) => {
                    const tipos = {
                        'escombros': 'üèóÔ∏è Escombros',
                        'deforestacion': 'üå≥ Deforestaci√≥n',
                        'incendio': 'üî• Incendio',
                        'deslizamiento': '‚õ∞Ô∏è Deslizamiento'
                    };
                    return tipos[tipo] || 'üìç Reporte';
                };
                
                container.innerHTML = recentReports.map(report => `
                    <div class="report-item ${report.tipo}" onclick="focusReport(${report.latitud}, ${report.longitud})">
                        <div class="report-item-header">
                            ${getTipoDisplay(report.tipo)}
                        </div>
                        <div class="report-item-info">
                            ${report.descripcion.substring(0, 50)}${report.descripcion.length > 50 ? '...' : ''}<br>
                            ${new Date(report.fecha_reporte).toLocaleDateString('es-EC')} - ${report.estado}
                        </div>
                    </div>
                `).join('');
                
                // Mostrar total de reportes
                totalContainer.innerHTML = `üìä Total de reportes en archivo: <strong>${citizenReports.length}</strong>`;
            }

            // Enfocar reporte en el mapa
            window.focusReport = function(lat, lng) {
                map.setView([lat, lng], 16);
            };

            // Toggle vista de reportes
            document.getElementById('toggle-reports-view-btn').addEventListener('click', () => {
                const form = document.getElementById('citizen-report-form');
                const list = document.getElementById('citizen-reports-list');
                const btn = document.getElementById('toggle-reports-view-btn');

                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    list.style.display = 'none';
                    btn.style.display = 'block'; // Mostrar bot√≥n
                    btn.textContent = 'Ver Reportes';
                    // Ocultar reportes del mapa
                    hideReportsFromMap();
                } else {
                    form.style.display = 'none';
                    list.style.display = 'block';
                    btn.style.display = 'none'; // Ocultar bot√≥n para evitar duplicaci√≥n
                    // Cargar y mostrar reportes
                    loadCitizenReports();
                }
            });

            // Bot√≥n cerrar reportes
            document.getElementById('close-reports-btn').addEventListener('click', () => {
                // Volver al formulario
                document.getElementById('citizen-report-form').style.display = 'block';
                document.getElementById('citizen-reports-list').style.display = 'none';
                document.getElementById('toggle-reports-view-btn').style.display = 'block';
                document.getElementById('toggle-reports-view-btn').textContent = 'Ver Reportes';
                
                // Ocultar reportes del mapa
                hideReportsFromMap();
                
                // Cerrar (colapsar) el panel completo
                const content = document.getElementById('citizen-report-content');
                const icon = document.getElementById('citizen-report-toggle-icon');
                content.classList.remove('expanded');
                icon.classList.add('collapsed');
            });

            // Bot√≥n nuevo reporte (desde la vista de reportes)
            document.getElementById('new-report-btn').addEventListener('click', () => {
                // Cambiar a vista de formulario
                document.getElementById('citizen-report-form').style.display = 'block';
                document.getElementById('citizen-reports-list').style.display = 'none';
                document.getElementById('toggle-reports-view-btn').style.display = 'block';
                document.getElementById('toggle-reports-view-btn').textContent = 'Ver Reportes';
                
                // Ocultar reportes del mapa
                hideReportsFromMap();
                
                // Limpiar formulario
                document.getElementById('report-type').value = '';
                document.getElementById('report-description').value = '';
                document.getElementById('report-name').value = '';
                document.getElementById('captcha-answer').value = '';
                document.getElementById('location-selected').style.display = 'none';
                document.getElementById('submit-report-btn').disabled = true;
                document.getElementById('form-validation-message').style.display = 'none';
                document.getElementById('name-feedback').textContent = '';
                document.getElementById('report-name').style.borderColor = '';
                generateCaptcha();
                
                if (reportMarker) {
                    map.removeLayer(reportMarker);
                    reportMarker = null;
                }
                reportLocation = null;
                document.getElementById('get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
            });

            // Funci√≥n para ocultar reportes del mapa
            function hideReportsFromMap() {
                reportMarkers.forEach(m => map.removeLayer(m));
                reportMarkers = [];
            }

            // Generar captcha al inicio
            generateCaptcha();

            // Obtener ubicaci√≥n actual
            document.getElementById('get-location-btn').addEventListener('click', async () => {
                if (!navigator.geolocation) {
                    alert('La geolocalizaci√≥n no est√° soportada en su navegador');
                    return;
                }

                document.getElementById('get-location-btn').textContent = '‚è≥ Obteniendo ubicaci√≥n...';
                document.getElementById('get-location-btn').disabled = true;

                // Verificar que la capa cuenca est√© cargada, si no, cargarla
                if (!layers['cuenca_guayllabamba'].layer) {
                    try {
                        await loadLayer('cuenca_guayllabamba');
                        // Marcar checkbox si se carg√≥ para validaci√≥n
                        document.getElementById('cuenca_guayllabamba').checked = true;
                    } catch (error) {
                        alert('‚ö†Ô∏è Error al cargar la capa de la Cuenca del r√≠o Guayllabamba. No se puede validar la ubicaci√≥n.');
                        document.getElementById('get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                        document.getElementById('get-location-btn').disabled = false;
                        return;
                    }
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const tempLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Verificar si est√° dentro de la cuenca
                        const pointInCuenca = isPointInLayer(tempLocation, layers['cuenca_guayllabamba'].layer);
                        
                        if (!pointInCuenca) {
                            alert('‚ö†Ô∏è Su ubicaci√≥n no se encuentra dentro de la Cuenca del r√≠o Guayllabamba. Solo se pueden reportar incidencias dentro del √°rea de estudio.');
                            document.getElementById('get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                            document.getElementById('get-location-btn').disabled = false;
                            return;
                        }

                        // Si est√° dentro de la cuenca, aceptar la ubicaci√≥n
                        reportLocation = tempLocation;

                        // Remover marcador anterior
                        if (reportMarker) {
                            map.removeLayer(reportMarker);
                        }

                        // Crear nuevo marcador
                        reportMarker = L.marker([reportLocation.lat, reportLocation.lng]).addTo(map);
                        
                        // Centrar mapa en la ubicaci√≥n
                        map.setView([reportLocation.lat, reportLocation.lng], 15);

                        // Actualizar UI
                        document.getElementById('get-location-btn').textContent = '‚úì Ubicaci√≥n obtenida';
                        document.getElementById('get-location-btn').disabled = false;
                        document.getElementById('location-selected').style.display = 'block';
                        validateForm();
                    },
                    (error) => {
                        let errorMsg = 'No se pudo obtener la ubicaci√≥n. ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += 'Por favor, permita el acceso a su ubicaci√≥n.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += 'Informaci√≥n de ubicaci√≥n no disponible.';
                                break;
                            case error.TIMEOUT:
                                errorMsg += 'Tiempo de espera agotado.';
                                break;
                        }
                        alert(errorMsg);
                        document.getElementById('get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                        document.getElementById('get-location-btn').disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });


            // Validar nombre completo (debe tener 4 partes: 2 nombres y 2 apellidos)
            function validateFullName(nombre) {
                const partes = nombre.trim().split(/\s+/); // Dividir por espacios
                return partes.length >= 4;
            }

            // Validar formulario
            function validateForm() {
                const tipo = document.getElementById('report-type').value;
                const descripcion = document.getElementById('report-description').value.trim();
                const nombre = document.getElementById('report-name').value.trim();
                const captchaInput = parseInt(document.getElementById('captcha-answer').value);
                const validationMessage = document.getElementById('form-validation-message');
                
                // Validar y mostrar mensajes espec√≠ficos
                let errors = [];
                
                if (!tipo) errors.push('‚Ä¢ Seleccione el tipo de reporte');
                if (!descripcion) errors.push('‚Ä¢ Ingrese una descripci√≥n');
                if (!nombre) {
                    errors.push('‚Ä¢ Ingrese su nombre completo');
                } else if (!validateFullName(nombre)) {
                    errors.push('‚Ä¢ El nombre debe incluir 2 nombres y 2 apellidos');
                }
                if (!reportLocation) errors.push('‚Ä¢ Obtenga su ubicaci√≥n GPS');
                if (isNaN(captchaInput) || captchaInput !== captchaAnswer) {
                    if (document.getElementById('captcha-answer').value) {
                        errors.push('‚Ä¢ Respuesta de verificaci√≥n incorrecta');
                    } else {
                        errors.push('‚Ä¢ Complete la verificaci√≥n');
                    }
                }
                
                // Mostrar mensaje de validaci√≥n si hay errores
                if (errors.length > 0) {
                    validationMessage.innerHTML = '<strong>‚ö†Ô∏è Complete los siguientes campos:</strong><br>' + errors.join('<br>');
                    validationMessage.style.display = 'block';
                } else {
                    validationMessage.style.display = 'none';
                }
                
                const isValid = tipo && descripcion && validateFullName(nombre) && 
                               reportLocation && captchaInput === captchaAnswer;
                
                document.getElementById('submit-report-btn').disabled = !isValid;
            }

            // Agregar listeners para validaci√≥n en tiempo real
            document.getElementById('report-type').addEventListener('change', validateForm);
            document.getElementById('report-description').addEventListener('input', validateForm);
            document.getElementById('captcha-answer').addEventListener('input', validateForm);
            
            // Validaci√≥n especial para el nombre con feedback visual
            document.getElementById('report-name').addEventListener('input', (e) => {
                const nombre = e.target.value.trim();
                const feedback = document.getElementById('name-feedback');
                const input = e.target;
                
                if (nombre === '') {
                    feedback.textContent = '';
                    input.style.borderColor = '';
                } else {
                    const partes = nombre.split(/\s+/);
                    if (partes.length < 4) {
                        feedback.textContent = `‚ö†Ô∏è Faltan ${4 - partes.length} ${partes.length === 3 ? 'palabra' : 'palabras'} (debe incluir 2 nombres y 2 apellidos)`;
                        feedback.style.color = '#dc3545';
                        input.style.borderColor = '#dc3545';
                    } else {
                        feedback.textContent = '‚úì Nombre completo v√°lido';
                        feedback.style.color = '#28a745';
                        input.style.borderColor = '#28a745';
                    }
                }
                
                validateForm();
            });

            // Enviar reporte
            document.getElementById('submit-report-btn').addEventListener('click', async () => {
                const tipo = document.getElementById('report-type').value;
                const descripcion = document.getElementById('report-description').value.trim();
                const nombre = document.getElementById('report-name').value.trim();

                // Validaciones
                if (!tipo || !descripcion || !nombre || !reportLocation) {
                    alert('Por favor complete todos los campos obligatorios y seleccione una ubicaci√≥n');
                    return;
                }

                // Validar nombre completo (4 partes)
                if (!validateFullName(nombre)) {
                    alert('‚ö†Ô∏è Por favor ingrese su nombre completo (2 nombres y 2 apellidos).\nEjemplo: Juan Carlos P√©rez Gonz√°lez');
                    return;
                }

                // Verificar captcha
                const captchaInput = parseInt(document.getElementById('captcha-answer').value);
                if (captchaInput !== captchaAnswer) {
                    alert('La respuesta de verificaci√≥n es incorrecta. Por favor intente nuevamente.');
                    generateCaptcha();
                    document.getElementById('captcha-answer').value = '';
                    return;
                }

                const reportData = {
                    tipo: tipo,
                    descripcion: descripcion,
                    nombre_reportante: nombre,
                    latitud: reportLocation.lat,
                    longitud: reportLocation.lng,
                    geom: {
                        type: "Point",
                        coordinates: [reportLocation.lng, reportLocation.lat]
                    }
                };
                
                // Log para debug
                console.log('Enviando reporte:', reportData);

                // Deshabilitar bot√≥n mientras se env√≠a
                const submitBtn = document.getElementById('submit-report-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';

                // Guardar en Supabase
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/reportes_ciudadanos`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify(reportData)
                        }
                    );

                    if (response.ok || response.status === 201) {
                        alert('‚úì Reporte enviado exitosamente. Gracias por su colaboraci√≥n.');

                        // Limpiar formulario
                        document.getElementById('report-type').value = '';
                        document.getElementById('report-description').value = '';
                        document.getElementById('report-name').value = '';
                        document.getElementById('captcha-answer').value = '';
                        document.getElementById('location-selected').style.display = 'none';
                        document.getElementById('get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                        generateCaptcha();
                        
                        if (reportMarker) {
                            map.removeLayer(reportMarker);
                            reportMarker = null;
                        }
                        reportLocation = null;

                        // Recargar reportes
                        await loadCitizenReports();
                    } else {
                        const errorText = await response.text();
                        console.error('Error del servidor:', errorText);
                        
                        // Intentar parsear el error de Supabase
                        try {
                            const errorJson = JSON.parse(errorText);
                            if (errorJson.message) {
                                alert('‚ö†Ô∏è Error al enviar el reporte:\n' + errorJson.message + '\n\nPor favor contacte al administrador del sistema.');
                            } else {
                                alert('‚ö†Ô∏è Error al enviar el reporte. C√≥digo: ' + response.status + '\n\nPor favor contacte al administrador del sistema.');
                            }
                        } catch (e) {
                            alert('‚ö†Ô∏è Error al enviar el reporte.\n\nDetalles: ' + errorText.substring(0, 200));
                        }
                    }
                } catch (error) {
                    alert('Error al enviar el reporte. Por favor verifique su conexi√≥n e intente nuevamente.');
                    console.error('Error guardando reporte:', error);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Reporte';
                }
            });

            // Cancelar reporte
            // Cancelar reporte
            document.getElementById('cancel-report-btn').addEventListener('click', () => {
                // Limpiar formulario
                document.getElementById('report-type').value = '';
                document.getElementById('report-description').value = '';
                document.getElementById('report-name').value = '';
                document.getElementById('captcha-answer').value = '';
                document.getElementById('location-selected').style.display = 'none';
                document.getElementById('submit-report-btn').disabled = true;
                document.getElementById('form-validation-message').style.display = 'none';
                document.getElementById('name-feedback').textContent = '';
                document.getElementById('report-name').style.borderColor = '';
                generateCaptcha();
                
                if (reportMarker) {
                    map.removeLayer(reportMarker);
                    reportMarker = null;
                }
                reportLocation = null;
                
                document.getElementById('get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                
                // Cerrar/colapsar el panel de Reporte Ciudadano
                const content = document.getElementById('citizen-report-content');
                const icon = document.getElementById('citizen-report-toggle-icon');
                content.classList.remove('expanded');
                icon.classList.add('collapsed');
            });

            // ===== AN√ÅLISIS DE CRUCES - Configurar ANTES de crear capas =====

            // ===== AN√ÅLISIS DE CRUCES - Configurar ANTES de crear capas =====
            
            // Bot√≥n de an√°lisis
            async function loadLayer(layerId) {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                try {
                    // Usar el l√≠mite de registros para pruebas
                    const limit = 5000;
                    
                    // Intentar con diferentes configuraciones para bosque_protector
                    const url = `${SUPABASE_URL}/rest/v1/${layerId}?select=*&limit=${limit}`;
                    console.log(`Intentando cargar: ${url}`);
                    
                    const response = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error al cargar capa: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log(`Respuesta de ${layerId}:`, data);
                    console.log(`Cargados ${data.length} registros de ${layerId}`);
                    
                    if (!data || data.length === 0) {
                        console.error(`La capa ${layerId} no tiene datos o la respuesta es inv√°lida`);
                        alert(`La capa ${layers[layerId].name} no tiene datos o hubo un error`);
                        loading.style.display = 'none';
                        return;
                    }
                    
                    // Crear capa seg√∫n tipo de geometr√≠a
                    const layerGroup = L.layerGroup();
                    const layerConfig = layers[layerId];
                    
                    data.forEach(feature => {
                        if (!feature.geom) return;
                        
                        try {
                            const geojson = typeof feature.geom === 'string' 
                                ? JSON.parse(feature.geom) 
                                : feature.geom;
                            
                            if (layerConfig.type === 'point') {
                                const coords = geojson.coordinates;
                                const marker = L.circleMarker([coords[1], coords[0]], {
                                    ...layerConfig.style,
                                    interactive: !analysisMode
                                });
                                marker.bindPopup(createPopup(feature, layerId));
                                marker.addTo(layerGroup);
                            } else {
                                // Crear GeoJSON con propiedades incluidas
                                const geoJsonFeature = {
                                    type: 'Feature',
                                    properties: feature,
                                    geometry: geojson
                                };
                                
                                const geoLayer = L.geoJSON(geoJsonFeature, {
                                    style: layerConfig.style,
                                    interactive: !analysisMode,
                                    onEachFeature: (f, geoFeature) => {
                                        geoFeature.bindPopup(createPopup(feature, layerId));
                                    }
                                });
                                geoLayer.addTo(layerGroup);
                            }
                        } catch (e) {
                            console.error('Error procesando geometr√≠a:', e);
                        }
                    });
                    
                    layers[layerId].layer = layerGroup;
                    layerGroup.addTo(map);
                    
                    // Ajustar vista solo si es la cuenca (capa base)
                    if (layerId === 'cuenca_guayllabamba' && data.length > 0) {
                        try {
                            const bounds = layerGroup.getBounds();
                            if (bounds.isValid()) {
                                // Expandir los l√≠mites un 20% para dar contexto
                                const expandedBounds = bounds.pad(0.2);
                                map.fitBounds(expandedBounds);
                            }
                        } catch (e) {
                            console.error('Error ajustando vista:', e);
                        }
                    }
                    
                } catch (error) {
                    console.error(`Error cargando ${layerId}:`, error);
                    alert(`No se pudo cargar la capa: ${layers[layerId].name}`);
                } finally {
                    loading.style.display = 'none';
                }
            }

            // Crear popup con informaci√≥n
            function createPopup(feature, layerId) {
                let html = `<strong>${layers[layerId].name}</strong><br>`;
                
                // Mostrar campos relevantes seg√∫n la capa
                if (layerId === 'cuenca_guayllabamba') {
                    if (feature.nam) html += `Nombre: ${feature.nam}<br>`;
                    if (feature.njr) html += `N.J.: ${feature.njr}<br>`;
                } else if (layerId === 'area_protegida') {
                    if (feature.nam) html += `Nombre: ${feature.nam}<br>`;
                    if (feature.map) html += `Categor√≠a: ${feature.map}<br>`;
                    if (feature.are) html += `√Årea: ${parseFloat(feature.are).toFixed(1)} Ha<br>`;
                } else if (layerId === 'bosque_protector') {
                    if (feature.nam) html += `Nombre: ${feature.nam}<br>`;
                    if (feature.tpbsq) html += `Tipo de bosque: ${feature.tpbsq}<br>`;
                    if (feature.are) html += `√Årea: ${parseFloat(feature.are).toFixed(1)} Ha<br>`;
                } else if (layerId === 'area_urbana') {
                    if (feature.nam) html += `Nombre: ${feature.nam}<br>`;
                    if (feature.descripcio) html += `Descripci√≥n: ${feature.descripcio}<br>`;
                } else if (layerId === 'deforestacion_20_22') {
                    if (feature.cbos) html += `Transici√≥n: ${feature.cbos}<br>`;
                    if (feature.txt) html += `Descripci√≥n: ${feature.txt}<br>`;
                } else if (layerId === 'punto_recoleccion_electronicos') {
                    if (feature.nam) html += `Nombre: ${feature.nam}<br>`;
                    if (feature.tip_rdu) html += `Tipo de residuos: ${feature.tip_rdu}<br>`;
                } else {
                    // Para otras capas, mostrar nam y fcode si existen
                    if (feature.nam) html += `nam: ${feature.nam}<br>`;
                    if (feature.fcode) html += `fcode: ${feature.fcode}<br>`;
                }
                
                return html;
            }

            // Toggle layer
            function toggleLayer(layerId) {
                const checkbox = document.getElementById(layerId);
                
                // Marcar si la capa fue cargada por el usuario (no por an√°lisis)
                if (checkbox.checked && !layers[layerId].layer) {
                    checkbox._wasLoadedBefore = true;
                }
                
                if (checkbox.checked) {
                    if (!layers[layerId].layer) {
                        // Cargar la capa si no existe
                        loadLayer(layerId);
                    } else {
                        // Si la capa existe pero no est√° en el mapa, agregarla
                        if (!map.hasLayer(layers[layerId].layer)) {
                            layers[layerId].layer.addTo(map);
                        }
                    }
                } else {
                    // Remover la capa del mapa si existe
                    if (layers[layerId].layer && map.hasLayer(layers[layerId].layer)) {
                        map.removeLayer(layers[layerId].layer);
                    }
                }
            }

            // Bot√≥n de an√°lisis
            const analysisBtn = document.getElementById('analysis-btn');
            analysisBtn.addEventListener('click', () => {
                analysisMode = !analysisMode;
                if (analysisMode) {
                    analysisBtn.textContent = '‚ùå Cancelar';
                    analysisBtn.classList.add('active');
                    
                    // Cerrar todos los popups abiertos
                    map.closePopup();
                    
                    // DESHABILITAR COMPLETAMENTE los popups del mapa
                    map._popup = null;
                    
                    // Deshabilitar interactividad y popups de todas las capas existentes
                    Object.keys(layers).forEach(layerId => {
                        if (layers[layerId].layer) {
                            layers[layerId].layer.eachLayer(l => {
                                // Guardar popup original
                                if (l.getPopup && l.getPopup()) {
                                    l._originalPopup = l.getPopup();
                                    l.unbindPopup();
                                }
                                
                                // Deshabilitar eventos de click en subcapas
                                if (l._layers) {
                                    Object.values(l._layers).forEach(sublayer => {
                                        if (sublayer.getPopup && sublayer.getPopup()) {
                                            sublayer._originalPopup = sublayer.getPopup();
                                            sublayer.unbindPopup();
                                        }
                                        sublayer.off('click');
                                    });
                                }
                                
                                l.off('click');
                            });
                        }
                    });
                    
                    // Forzar cursor en todo el contenedor del mapa
                    const mapContainer = map.getContainer();
                    mapContainer.style.cursor = 'crosshair !important';
                    mapContainer.classList.add('analysis-cursor');
                } else {
                    analysisBtn.textContent = 'üìç Seleccionar punto';
                    analysisBtn.classList.remove('active');
                    
                    // Reactivar popups de todas las capas (SIN recargar las capas)
                    Object.keys(layers).forEach(layerId => {
                        if (layers[layerId].layer) {
                            layers[layerId].layer.eachLayer(l => {
                                // Restaurar popup original
                                if (l._originalPopup) {
                                    l.bindPopup(l._originalPopup);
                                    delete l._originalPopup;
                                }
                                
                                // Restaurar popups en subcapas
                                if (l._layers) {
                                    Object.values(l._layers).forEach(sublayer => {
                                        if (sublayer._originalPopup) {
                                            sublayer.bindPopup(sublayer._originalPopup);
                                            delete sublayer._originalPopup;
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    const mapContainer = map.getContainer();
                    mapContainer.style.cursor = '';
                    mapContainer.classList.remove('analysis-cursor');
                    
                    if (analysisMarker) {
                        map.removeLayer(analysisMarker);
                        analysisMarker = null;
                    }
                }
            });

            // Click en el mapa para an√°lisis
            map.on('click', async (e) => {
                console.log('Click detectado, analysisMode:', analysisMode);
                
                if (!analysisMode) return;
                
                console.log('Click en modo an√°lisis detectado');
                
                // Cerrar popup inmediatamente
                setTimeout(() => map.closePopup(), 0);

                const latlng = e.latlng;
                
                console.log('Coordenadas:', latlng);
                
                // Verificar que la capa cuenca est√© cargada Y visible
                const cuencaCheckbox = document.getElementById('cuenca_guayllabamba');
                if (!cuencaCheckbox.checked || !layers['cuenca_guayllabamba'].layer) {
                    showResult('Error - Capa requerida', '‚ö†Ô∏è Para realizar el an√°lisis es necesario que la capa "Cuenca del r√≠o Guayllabamba" est√© activada.<br><br>Por favor, active la capa en el panel de control y vuelva a intentar.', 'warning');
                    return;
                }

                // Colocar marcador
                if (analysisMarker) {
                    map.removeLayer(analysisMarker);
                }
                analysisMarker = L.marker(latlng).addTo(map);

                console.log('Verificando si est√° en cuenca...');
                
                // Verificar si est√° dentro de la cuenca
                const pointInCuenca = isPointInLayer(latlng, layers['cuenca_guayllabamba'].layer);
                
                console.log('¬øPunto en cuenca?', pointInCuenca);
                
                if (!pointInCuenca) {
                    // Limpiar datos del an√°lisis anterior
                    lastAnalysisData = null;
                    showResult('Fuera del √°rea de estudio', 'El punto seleccionado no se encuentra dentro de la Cuenca del r√≠o Guayllabamba.<br><br>Por favor seleccione un punto dentro del √°rea de estudio.', 'warning');
                    return;
                }

                console.log('Punto dentro de cuenca, analizando √°reas sensibles...');
                
                // Analizar cruce con √°reas sensibles
                const results = [];

                // Verificar √°rea protegida
                if (layers['area_protegida'].layer) {
                    console.log('Verificando √°rea protegida (ya cargada)...');
                    const inAreaProtegida = getIntersectingFeatures(latlng, layers['area_protegida'].layer);
                    console.log('√Åreas protegidas encontradas:', inAreaProtegida.length);
                    if (inAreaProtegida.length > 0) {
                        results.push({
                            tipo: '√Årea Protegida',
                            features: inAreaProtegida
                        });
                    }
                } else {
                    console.log('Cargando √°rea protegida...');
                    // Cargar la capa si no est√° cargada
                    await loadLayer('area_protegida');
                    // Marcar checkbox como activo
                    document.getElementById('area_protegida').checked = true;
                    
                    if (layers['area_protegida'].layer) {
                        const inAreaProtegida = getIntersectingFeatures(latlng, layers['area_protegida'].layer);
                        console.log('√Åreas protegidas encontradas:', inAreaProtegida.length);
                        if (inAreaProtegida.length > 0) {
                            results.push({
                                tipo: '√Årea Protegida',
                                features: inAreaProtegida
                            });
                        }
                    }
                }

                // Verificar bosque protector
                if (layers['bosque_protector'].layer) {
                    console.log('Verificando bosque protector (ya cargado)...');
                    const inBosqueProtector = getIntersectingFeatures(latlng, layers['bosque_protector'].layer);
                    console.log('Bosques protectores encontrados:', inBosqueProtector.length);
                    if (inBosqueProtector.length > 0) {
                        results.push({
                            tipo: 'Bosque Protector',
                            features: inBosqueProtector
                        });
                    }
                } else {
                    console.log('Cargando bosque protector...');
                    // Cargar la capa si no est√° cargada
                    await loadLayer('bosque_protector');
                    // Marcar checkbox como activo
                    document.getElementById('bosque_protector').checked = true;
                    
                    if (layers['bosque_protector'].layer) {
                        const inBosqueProtector = getIntersectingFeatures(latlng, layers['bosque_protector'].layer);
                        console.log('Bosques protectores encontrados:', inBosqueProtector.length);
                        if (inBosqueProtector.length > 0) {
                            results.push({
                                tipo: 'Bosque Protector',
                                features: inBosqueProtector
                            });
                        }
                    }
                }

                console.log('Resultados totales:', results);
                
                // Guardar datos para el reporte
                lastAnalysisData = {
                    latlng: latlng,
                    results: results,
                    timestamp: new Date()
                };
                
                console.log('Datos guardados para reporte:', lastAnalysisData);
                
                // Mostrar resultados
                if (results.length > 0) {
                    let content = '<p><strong>‚ö†Ô∏è ALERTA: El punto se encuentra en:</strong></p>';
                    results.forEach(result => {
                        content += `<p><strong>${result.tipo}:</strong><br>`;
                        result.features.forEach(f => {
                            if (f.nam) content += `‚Ä¢ ${f.nam}<br>`;
                        });
                        content += '</p>';
                    });
                    showResult('Cruce con √°reas sensibles detectado', content, 'warning');
                } else {
                    showResult('Sin cruces detectados', '‚úÖ El punto NO se encuentra dentro de √°reas protegidas ni bosques protectores.', 'success');
                }
            });

            // Funci√≥n para verificar si un punto est√° en una capa
            function isPointInLayer(latlng, layerGroup) {
                let inside = false;
                console.log('Analizando capas en layerGroup...');
                console.log('LayerGroup:', layerGroup);
                
                let layerCount = 0;
                layerGroup.eachLayer((layer) => {
                    layerCount++;
                    console.log('Layer #' + layerCount + ':', layer);
                    console.log('  - tiene feature?', !!layer.feature);
                    console.log('  - tiene _layers?', !!layer._layers);
                    
                    // Para capas GeoJSON
                    if (layer.feature && layer.feature.geometry) {
                        console.log('  - Verificando geometr√≠a directa');
                        const point = [latlng.lng, latlng.lat];
                        if (isPointInPolygon(point, layer.feature.geometry)) {
                            console.log('  - ‚úì Punto encontrado dentro!');
                            inside = true;
                        }
                    }
                    // Para capas con m√∫ltiples features
                    else if (layer._layers) {
                        console.log('  - Tiene subcapas, explorando...');
                        Object.values(layer._layers).forEach(sublayer => {
                            console.log('    - Sublayer:', sublayer);
                            if (sublayer.feature && sublayer.feature.geometry) {
                                console.log('    - Verificando geometr√≠a de sublayer');
                                console.log('    - Geometr√≠a:', sublayer.feature.geometry);
                                const point = [latlng.lng, latlng.lat];
                                console.log('    - Punto a verificar:', point);
                                const result = isPointInPolygon(point, sublayer.feature.geometry);
                                console.log('    - Resultado isPointInPolygon:', result);
                                if (result) {
                                    console.log('    - ‚úì Punto encontrado dentro de sublayer!');
                                    inside = true;
                                }
                            } else {
                                console.log('    - Sublayer no tiene feature.geometry');
                            }
                        });
                    }
                });
                
                console.log('Total de layers procesados:', layerCount);
                return inside;
            }

            // Funci√≥n para obtener features que contienen el punto
            function getIntersectingFeatures(latlng, layerGroup) {
                const features = [];
                
                layerGroup.eachLayer((layer) => {
                    // Para capas GeoJSON
                    if (layer.feature && layer.feature.geometry) {
                        const point = [latlng.lng, latlng.lat];
                        if (isPointInPolygon(point, layer.feature.geometry)) {
                            features.push(layer.feature.properties);
                        }
                    }
                    // Para capas con m√∫ltiples features
                    else if (layer._layers) {
                        Object.values(layer._layers).forEach(sublayer => {
                            if (sublayer.feature && sublayer.feature.geometry) {
                                const point = [latlng.lng, latlng.lat];
                                if (isPointInPolygon(point, sublayer.feature.geometry)) {
                                    features.push(sublayer.feature.properties);
                                }
                            }
                        });
                    }
                });
                
                return features;
            }

            // Funci√≥n simple para verificar punto en pol√≠gono
            function isPointInPolygon(point, geometry) {
                console.log('      - isPointInPolygon llamado');
                console.log('      - Tipo de geometr√≠a:', geometry.type);
                
                if (geometry.type === 'Polygon') {
                    console.log('      - Es Polygon, verificando...');
                    const result = pointInPolygon(point, geometry.coordinates[0]);
                    console.log('      - Resultado Polygon:', result);
                    return result;
                } else if (geometry.type === 'MultiPolygon') {
                    console.log('      - Es MultiPolygon, verificando cada pol√≠gono...');
                    for (let i = 0; i < geometry.coordinates.length; i++) {
                        const poly = geometry.coordinates[i];
                        console.log('      - Verificando pol√≠gono', i);
                        if (pointInPolygon(point, poly[0])) {
                            console.log('      - ‚úì Encontrado en pol√≠gono', i);
                            return true;
                        }
                    }
                    console.log('      - No encontrado en ning√∫n pol√≠gono');
                    return false;
                }
                console.log('      - Tipo de geometr√≠a no reconocido');
                return false;
            }

            // Ray casting algorithm
            function pointInPolygon(point, polygon) {
                let x = point[0], y = point[1];
                let inside = false;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    let xi = polygon[i][0], yi = polygon[i][1];
                    let xj = polygon[j][0], yj = polygon[j][1];
                    let intersect = ((yi > y) != (yj > y))
                        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            }

            // Mostrar resultado
            function showResult(title, content, type) {
                const popup = document.getElementById('result-popup');
                const printBtn = document.getElementById('print-report-btn');
                
                document.getElementById('result-title').textContent = title;
                document.getElementById('result-content').innerHTML = content;
                popup.className = 'result-popup ' + type;
                popup.style.display = 'block';
                
                // Mostrar u ocultar bot√≥n de imprimir seg√∫n si hay datos de an√°lisis
                if (lastAnalysisData) {
                    printBtn.style.display = 'inline-block';
                } else {
                    printBtn.style.display = 'none';
                }
            }

            // Mostrar informaci√≥n de capa
            function showLayerInfo(layerId) {
                const info = layerInfo[layerId];
                if (!info) return;
                
                document.getElementById('info-title').textContent = info.nombre;
                
                let content = `<p><strong>Descripci√≥n:</strong><br>${info.descripcion}</p>`;
                if (info.fuente) content += `<p><strong>Fuente:</strong> ${info.fuente}</p>`;
                if (info.fecha) content += `<p><strong>Fecha:</strong> ${info.fecha}</p>`;
                
                document.getElementById('info-content').innerHTML = content;
                document.getElementById('info-overlay').style.display = 'block';
                document.getElementById('info-popup').style.display = 'block';
            }

            // Funci√≥n para generar e imprimir reporte
            async function printReport() {
                if (!lastAnalysisData) {
                    console.error('No hay datos de an√°lisis guardados');
                    alert('No hay datos de an√°lisis para imprimir. Por favor realice un an√°lisis primero.');
                    return;
                }
                
                const { latlng, results, timestamp } = lastAnalysisData;
                
                console.log('Generando reporte con:', {
                    latlng,
                    results,
                    timestamp,
                    layerInfoExists: typeof layerInfo !== 'undefined'
                });
                
                // Tomar screenshot del mapa
                const mapElement = document.getElementById('map');
                let screenshotDataUrl = '';
                
                try {
                    // Usar html2canvas si est√° disponible, sino continuar sin screenshot
                    if (typeof html2canvas !== 'undefined') {
                        const canvas = await html2canvas(mapElement);
                        screenshotDataUrl = canvas.toDataURL('image/png');
                    }
                } catch (e) {
                    console.log('No se pudo capturar screenshot:', e);
                }
                
                // Generar HTML del reporte
                const reportHTML = `
                    <div class="report-header">
                        <h1>EcoGuayllabamba</h1>
                        <h2>Reporte de An√°lisis Espacial - Definici√≥n de cruce con √°reas sensibles</h2>
                        <p>Geoportal para la gesti√≥n ambiental y mitigaci√≥n del riesgo en la cuenca del r√≠o Guayllabamba</p>
                    </div>
                    
                    <div class="report-section">
                        <h2>Informaci√≥n de la Consulta</h2>
                        <div class="report-info-grid">
                            <div class="report-info-label">Fecha y Hora:</div>
                            <div class="report-info-value">${timestamp.toLocaleString('es-EC', { 
                                dateStyle: 'full', 
                                timeStyle: 'medium' 
                            })}</div>
                            
                            <div class="report-info-label">Coordenadas:</div>
                            <div class="report-info-value">
                                Latitud: ${latlng.lat.toFixed(6)}¬∞<br>
                                Longitud: ${latlng.lng.toFixed(6)}¬∞
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h2>Resultado del An√°lisis</h2>
                        ${results.length > 0 ? `
                            <div class="report-result-box">
                                <strong>‚ö†Ô∏è ALERTA: Se detect√≥ cruce con √°reas sensibles</strong>
                                ${results.map(result => `
                                    <p style="margin-top: 15px;">
                                        <strong>${result.tipo}:</strong><br>
                                        ${result.features.map(f => `‚Ä¢ ${f.nam || 'Sin nombre'}`).join('<br>')}
                                    </p>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="report-result-box success">
                                <strong>‚úÖ Sin cruces detectados</strong>
                                <p>El punto analizado NO se encuentra dentro de √°reas protegidas ni bosques protectores.</p>
                            </div>
                        `}
                    </div>
                    
                    <div class="report-section" style="page-break-inside: auto;">
                        <h2>Capas Utilizadas en el An√°lisis</h2>
                        
                        <div class="report-layer-info" style="page-break-inside: avoid;">
                            <h3>1. ${layerInfo['cuenca_guayllabamba'].nombre}</h3>
                            <p><strong>Descripci√≥n:</strong> ${layerInfo['cuenca_guayllabamba'].descripcion}</p>
                            <p><strong>Fuente:</strong> ${layerInfo['cuenca_guayllabamba'].fuente}</p>
                            <p><strong>Fecha de informaci√≥n:</strong> ${layerInfo['cuenca_guayllabamba'].fecha}</p>
                        </div>
                        
                        <div class="report-layer-info" style="page-break-inside: avoid;">
                            <h3>2. ${layerInfo['area_protegida'].nombre}</h3>
                            <p><strong>Descripci√≥n:</strong> ${layerInfo['area_protegida'].descripcion}</p>
                            <p><strong>Fuente:</strong> ${layerInfo['area_protegida'].fuente}</p>
                            <p><strong>Fecha de informaci√≥n:</strong> ${layerInfo['area_protegida'].fecha}</p>
                        </div>
                        
                        <div class="report-layer-info" style="page-break-inside: avoid;">
                            <h3>3. ${layerInfo['bosque_protector'].nombre}</h3>
                            <p><strong>Descripci√≥n:</strong> ${layerInfo['bosque_protector'].descripcion}</p>
                            <p><strong>Fuente:</strong> ${layerInfo['bosque_protector'].fuente}</p>
                            <p><strong>Fecha de informaci√≥n:</strong> ${layerInfo['bosque_protector'].fecha}</p>
                        </div>
                    </div>
                    
                    ${screenshotDataUrl ? `
                        <div class="report-section">
                            <h2>Visualizaci√≥n del Mapa</h2>
                            <img src="${screenshotDataUrl}" alt="Captura del mapa" class="report-map-screenshot">
                        </div>
                    ` : ''}
                    
                    <div class="report-section" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <p style="text-align: center; color: #7f8c8d; font-size: 12px;">
                            Este reporte fue generado autom√°ticamente por <strong>EcoGuayllabamba</strong><br>
                            Geoportal para la gesti√≥n ambiental y mitigaci√≥n del riesgo en la cuenca del r√≠o Guayllabamba<br>
                            ${new Date().toLocaleString('es-EC')}
                        </p>
                    </div>
                `;
                
                console.log('HTML del reporte generado, longitud:', reportHTML.length);
                
                // Insertar HTML en el contenedor de impresi√≥n
                const printContainer = document.getElementById('print-report');
                if (!printContainer) {
                    console.error('No se encontr√≥ el contenedor #print-report');
                    alert('Error: No se encontr√≥ el contenedor de impresi√≥n');
                    return;
                }
                
                printContainer.innerHTML = reportHTML;
                printContainer.style.display = 'block';
                
                console.log('Contenedor de impresi√≥n actualizado, iniciando impresi√≥n...');
                
                // Detectar si es m√≥vil
                const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // En m√≥viles: abrir en nueva ventana/pesta√±a para mejor experiencia
                    const reportWindow = window.open('', '_blank');
                    if (reportWindow) {
                        reportWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>Reporte EcoGuayllabamba</title>
                                <style>
                                    * {
                                        margin: 0;
                                        padding: 0;
                                        box-sizing: border-box;
                                    }
                                    body {
                                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                                        padding: 20px;
                                        background: #f5f5f5;
                                        line-height: 1.6;
                                    }
                                    .report-container {
                                        max-width: 800px;
                                        margin: 0 auto;
                                        background: white;
                                        padding: 20px;
                                        border-radius: 8px;
                                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                    }
                                    .report-header {
                                        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
                                        color: white;
                                        padding: 30px;
                                        text-align: center;
                                        border-radius: 8px;
                                        margin-bottom: 30px;
                                    }
                                    .report-header h1 {
                                        margin: 0;
                                        font-size: 24px;
                                    }
                                    .report-header h2 {
                                        margin: 10px 0;
                                        font-size: 16px;
                                        font-weight: normal;
                                    }
                                    .report-header p {
                                        margin: 5px 0 0 0;
                                        font-size: 13px;
                                    }
                                    .report-section {
                                        margin-bottom: 25px;
                                        padding: 20px;
                                        border: 1px solid #e0e0e0;
                                        border-radius: 8px;
                                    }
                                    .report-section h2 {
                                        color: #27ae60;
                                        margin-bottom: 15px;
                                        font-size: 18px;
                                        margin-top: 0;
                                    }
                                    .report-info-grid {
                                        display: grid;
                                        grid-template-columns: 150px 1fr;
                                        gap: 10px;
                                        margin-top: 15px;
                                    }
                                    .report-info-label {
                                        font-weight: bold;
                                        color: #2c3e50;
                                    }
                                    .report-info-value {
                                        color: #2c3e50;
                                    }
                                    .report-result-box {
                                        background: #fff3cd;
                                        border-left: 4px solid #ffc107;
                                        padding: 20px;
                                        border-radius: 5px;
                                        margin-top: 15px;
                                    }
                                    .report-result-box.success {
                                        background: #d4edda;
                                        border-left-color: #28a745;
                                    }
                                    .report-layer-info {
                                        margin-bottom: 20px;
                                    }
                                    .report-layer-info h3 {
                                        color: #2c3e50;
                                        margin-bottom: 10px;
                                        font-size: 16px;
                                    }
                                    .report-layer-info p {
                                        margin-bottom: 8px;
                                        color: #555;
                                    }
                                    .report-map-screenshot {
                                        width: 100%;
                                        border-radius: 8px;
                                        margin-top: 15px;
                                    }
                                    .print-button {
                                        position: fixed;
                                        bottom: 20px;
                                        right: 20px;
                                        background: #27ae60;
                                        color: white;
                                        border: none;
                                        padding: 15px 25px;
                                        border-radius: 50px;
                                        font-size: 16px;
                                        font-weight: bold;
                                        cursor: pointer;
                                        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
                                        z-index: 1000;
                                    }
                                    .print-button:active {
                                        transform: scale(0.95);
                                    }
                                    @media print {
                                        body {
                                            background: white;
                                            padding: 0;
                                        }
                                        .report-container {
                                            box-shadow: none;
                                            padding: 0;
                                        }
                                        .print-button {
                                            display: none;
                                        }
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="report-container">
                                    ${reportHTML}
                                </div>
                                <button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                            </body>
                            </html>
                        `);
                        reportWindow.document.close();
                    } else {
                        alert('Por favor permita ventanas emergentes para ver el reporte.');
                    }
                    
                    // Limpiar contenedor en la ventana principal
                    setTimeout(() => {
                        printContainer.innerHTML = '';
                        printContainer.style.display = 'none';
                    }, 500);
                } else {
                    // En desktop: usar window.print() tradicional
                    window.print();
                    
                    // Limpiar despu√©s de imprimir
                    setTimeout(() => {
                        printContainer.innerHTML = '';
                        printContainer.style.display = 'none';
                    }, 1000);
                }
            }

            // ===== GESTI√ìN DE ESCOMBROS Y RECICLABLES =====
            
            let recyclingLocation = null;
            let recyclingMarker = null;
            let wasteSearchLocation = null;
            let wasteSearchMarker = null;
            let wastePointMarkers = [];

            // 1. COMPRA DE RECICLABLES - Obtener ubicaci√≥n
            document.getElementById('recycling-get-location-btn').addEventListener('click', async () => {
                if (!navigator.geolocation) {
                    alert('La geolocalizaci√≥n no est√° soportada en su navegador');
                    return;
                }

                document.getElementById('recycling-get-location-btn').textContent = '‚è≥ Obteniendo ubicaci√≥n...';
                document.getElementById('recycling-get-location-btn').disabled = true;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        recyclingLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Remover marcador anterior
                        if (recyclingMarker) {
                            map.removeLayer(recyclingMarker);
                        }

                        // Crear nuevo marcador
                        recyclingMarker = L.marker([recyclingLocation.lat, recyclingLocation.lng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSI0MSIgdmlld0JveD0iMCAwIDI1IDQxIj48cGF0aCBmaWxsPSIjMjdhZTYwIiBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEwLjQgMTIuNSAyOC41IDEyLjUgMjguNVMyNSAyMi45IDI1IDEyLjVDMjUgNS42IDE5LjQgMCAxMi41IDB6bTAgMTcuNWMtMi44IDAtNS0yLjItNS01czIuMi01IDUtNSA1IDIuMiA1IDUtMi4yIDUtNSA1eiIvPjwvc3ZnPg==',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41]
                            })
                        }).addTo(map);
                        
                        // Centrar mapa en la ubicaci√≥n
                        map.setView([recyclingLocation.lat, recyclingLocation.lng], 15);

                        // Actualizar UI
                        document.getElementById('recycling-get-location-btn').textContent = '‚úì Ubicaci√≥n obtenida';
                        document.getElementById('recycling-get-location-btn').disabled = false;
                        document.getElementById('recycling-location-selected').style.display = 'block';
                        validateRecyclingForm();
                    },
                    (error) => {
                        alert('No se pudo obtener la ubicaci√≥n. Por favor, permita el acceso a su ubicaci√≥n.');
                        document.getElementById('recycling-get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                        document.getElementById('recycling-get-location-btn').disabled = false;
                    }
                );
            });

            // Validar formulario de reciclables
            function validateRecyclingForm() {
                const name = document.getElementById('recycling-name').value.trim();
                const checkboxes = document.querySelectorAll('#recycling-purchase-content input[type="checkbox"]:checked');
                
                const isValid = name && recyclingLocation && checkboxes.length > 0;
                document.getElementById('submit-recycling-btn').disabled = !isValid;
            }

            document.getElementById('recycling-name').addEventListener('input', validateRecyclingForm);
            document.querySelectorAll('#recycling-purchase-content input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', validateRecyclingForm);
            });

            // Enviar punto de reciclaje
            document.getElementById('submit-recycling-btn').addEventListener('click', async () => {
                const name = document.getElementById('recycling-name').value.trim();
                const checkboxes = document.querySelectorAll('#recycling-purchase-content input[type="checkbox"]:checked');
                const wasteTypes = Array.from(checkboxes).map(cb => cb.value).join(', ');

                // Formato GeoJSON para PostGIS
                const recyclingData = {
                    nam: name,
                    tip_rdu: wasteTypes,
                    geom: {
                        type: "Point",
                        coordinates: [recyclingLocation.lng, recyclingLocation.lat]
                    }
                };

                const submitBtn = document.getElementById('submit-recycling-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registrando...';

                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/punto_recoleccion_electronicos`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(recyclingData)
                        }
                    );

                    if (response.ok || response.status === 201) {
                        const insertedData = await response.json();
                        
                        if (insertedData && insertedData.length > 0) {
                            const newGid = insertedData[0].gid;
                            
                            // Verificar que el registro existe con un SELECT
                            try {
                                const verifyResponse = await fetch(
                                    `${SUPABASE_URL}/rest/v1/punto_recoleccion_electronicos?gid=eq.${newGid}`,
                                    {
                                        headers: {
                                            'apikey': SUPABASE_KEY,
                                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                                            'Content-Type': 'application/json'
                                        }
                                    }
                                );
                                const verifyData = await verifyResponse.json();
                                console.log('Verificaci√≥n del registro:', verifyData);
                                
                                if (verifyData && verifyData.length > 0) {
                                    alert(`‚úì Punto de compra registrado y verificado.\nID: ${newGid}\nNombre: ${verifyData[0].nam}`);
                                } else {
                                    alert(`‚ö†Ô∏è Registro creado (ID: ${newGid}) pero no se puede recuperar. Puede ser un problema de permisos de lectura.`);
                                }
                            } catch (verifyError) {
                                console.error('Error verificando:', verifyError);
                                alert(`‚úì Punto registrado (ID: ${newGid}) pero no se pudo verificar.`);
                            }
                        } else {
                            alert('‚ö†Ô∏è El registro se proces√≥ pero no se confirmaron los datos.');
                        }

                        // Limpiar formulario
                        document.getElementById('recycling-name').value = '';
                        document.querySelectorAll('#recycling-purchase-content input[type="checkbox"]').forEach(cb => cb.checked = false);
                        document.getElementById('recycling-location-selected').style.display = 'none';
                        document.getElementById('recycling-get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                        
                        if (recyclingMarker) {
                            map.removeLayer(recyclingMarker);
                            recyclingMarker = null;
                        }
                        recyclingLocation = null;

                        // Recargar capa si est√° activa
                        if (document.getElementById('punto_recoleccion_electronicos').checked) {
                            map.removeLayer(layers['punto_recoleccion_electronicos'].layer);
                            layers['punto_recoleccion_electronicos'].layer = null;
                            await loadLayer('punto_recoleccion_electronicos');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Error del servidor:', errorText);
                        alert('Error al registrar el punto: ' + errorText);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n. Por favor intente nuevamente.');
                    console.error('Error:', error);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Registrar Punto';
                }
            });

            // Cancelar registro de reciclables
            // Cancelar registro de reciclables
            document.getElementById('cancel-recycling-btn').addEventListener('click', () => {
                document.getElementById('recycling-name').value = '';
                document.querySelectorAll('#recycling-purchase-content input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.getElementById('recycling-location-selected').style.display = 'none';
                document.getElementById('submit-recycling-btn').disabled = true;
                document.getElementById('recycling-get-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                
                if (recyclingMarker) {
                    map.removeLayer(recyclingMarker);
                    recyclingMarker = null;
                }
                recyclingLocation = null;

                // Cerrar sub-panel de compra de reciclables
                const recyclingContent = document.getElementById('recycling-purchase-content');
                const recyclingIcon = document.getElementById('recycling-purchase-toggle-icon');
                recyclingContent.classList.remove('expanded');
                recyclingIcon.classList.add('collapsed');
            });

            // 2. TENGO RESIDUOS - Obtener ubicaci√≥n
            document.getElementById('waste-search-location-btn').addEventListener('click', async () => {
                if (!navigator.geolocation) {
                    alert('La geolocalizaci√≥n no est√° soportada en su navegador');
                    return;
                }

                document.getElementById('waste-search-location-btn').textContent = '‚è≥ Obteniendo ubicaci√≥n...';
                document.getElementById('waste-search-location-btn').disabled = true;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        wasteSearchLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Remover marcador anterior
                        if (wasteSearchMarker) {
                            map.removeLayer(wasteSearchMarker);
                        }

                        // Crear nuevo marcador
                        wasteSearchMarker = L.marker([wasteSearchLocation.lat, wasteSearchLocation.lng]).addTo(map);
                        
                        // Centrar mapa
                        map.setView([wasteSearchLocation.lat, wasteSearchLocation.lng], 13);

                        // Actualizar UI
                        document.getElementById('waste-search-location-btn').textContent = '‚úì Ubicaci√≥n obtenida';
                        document.getElementById('waste-search-location-btn').disabled = false;
                        document.getElementById('waste-location-selected').style.display = 'block';
                        validateWasteSearchForm();
                    },
                    (error) => {
                        alert('No se pudo obtener la ubicaci√≥n. Por favor, permita el acceso a su ubicaci√≥n.');
                        document.getElementById('waste-search-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                        document.getElementById('waste-search-location-btn').disabled = false;
                    }
                );
            });

            // Validar formulario de b√∫squeda de residuos
            function validateWasteSearchForm() {
                const wasteType = document.getElementById('waste-type-search').value;
                const isValid = wasteType && wasteSearchLocation;
                document.getElementById('search-waste-points-btn').disabled = !isValid;
            }

            document.getElementById('waste-type-search').addEventListener('change', validateWasteSearchForm);

            // Buscar puntos cercanos
            document.getElementById('search-waste-points-btn').addEventListener('click', async () => {
                const wasteType = document.getElementById('waste-type-search').value;
                
                const searchBtn = document.getElementById('search-waste-points-btn');
                searchBtn.disabled = true;
                searchBtn.textContent = 'Buscando...';

                try {
                    // Cargar todos los puntos de recolecci√≥n
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/punto_recoleccion_electronicos?select=*`,
                        {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (response.ok) {
                        const allPoints = await response.json();
                        
                        // Filtrar puntos que aceptan el tipo de residuo
                        const matchingPoints = allPoints.filter(point => 
                            point.tip_rdu && point.tip_rdu.toLowerCase().includes(wasteType.toLowerCase())
                        );

                        if (matchingPoints.length === 0) {
                            document.getElementById('waste-results-list').innerHTML = 
                                '<p style="color:#e74c3c; font-size:12px;">No se encontraron puntos que acepten este tipo de residuo.</p>';
                            document.getElementById('waste-results').style.display = 'block';
                            searchBtn.disabled = false;
                            searchBtn.textContent = 'Buscar puntos cercanos';
                            return;
                        }

                        // Calcular distancias (extrayendo coordenadas del campo geom)
                        const pointsWithDistance = matchingPoints.map(point => {
                            // Extraer coordenadas del geom (que puede ser string JSON o objeto)
                            let lat, lng;
                            if (point.geom) {
                                const geom = typeof point.geom === 'string' ? JSON.parse(point.geom) : point.geom;
                                if (geom.coordinates) {
                                    lng = geom.coordinates[0];
                                    lat = geom.coordinates[1];
                                }
                            }
                            
                            // Si no hay coordenadas v√°lidas, saltar este punto
                            if (!lat || !lng) return null;
                            
                            const distance = calculateDistance(
                                wasteSearchLocation.lat,
                                wasteSearchLocation.lng,
                                lat,
                                lng
                            );
                            return { ...point, lat, lng, distance };
                        }).filter(p => p !== null); // Eliminar puntos sin coordenadas

                        if (pointsWithDistance.length === 0) {
                            document.getElementById('waste-results-list').innerHTML = 
                                '<p style="color:#e74c3c; font-size:12px;">No se pudieron calcular las distancias de los puntos encontrados.</p>';
                            document.getElementById('waste-results').style.display = 'block';
                            searchBtn.disabled = false;
                            searchBtn.textContent = 'Buscar puntos cercanos';
                            return;
                        }

                        // Ordenar por distancia y tomar los 3 m√°s cercanos
                        const nearest = pointsWithDistance.sort((a, b) => a.distance - b.distance).slice(0, 3);

                        // Limpiar marcadores anteriores
                        wastePointMarkers.forEach(m => map.removeLayer(m));
                        wastePointMarkers = [];

                        // Mostrar resultados
                        let resultsHTML = '';
                        nearest.forEach((point, index) => {
                            resultsHTML += `
                                <div style="background:white; padding:10px; margin-bottom:10px; border-radius:3px; border-left:3px solid #27ae60; cursor:pointer;"
                                     onclick="map.setView([${point.lat}, ${point.lng}], 16)">
                                    <strong>${index + 1}. ${point.nam || 'Punto de recolecci√≥n'}</strong><br>
                                    <small style="color:#7f8c8d;">Distancia: ${point.distance.toFixed(2)} km</small><br>
                                    <small style="color:#7f8c8d;">Acepta: ${point.tip_rdu}</small>
                                </div>
                            `;

                            // Agregar marcador en el mapa
                            const marker = L.circleMarker([point.lat, point.lng], {
                                radius: 10,
                                fillColor: '#27ae60',
                                color: 'white',
                                weight: 2,
                                fillOpacity: 0.9
                            });
                            marker.bindPopup(`<strong>${point.nam}</strong><br>${point.tip_rdu}<br>${point.distance.toFixed(2)} km`);
                            marker.addTo(map);
                            wastePointMarkers.push(marker);
                        });

                        document.getElementById('waste-results-list').innerHTML = resultsHTML;
                        document.getElementById('waste-results').style.display = 'block';

                        // Ajustar vista del mapa para mostrar todos los puntos
                        const bounds = L.latLngBounds([
                            [wasteSearchLocation.lat, wasteSearchLocation.lng],
                            ...nearest.map(p => [p.lat, p.lng])
                        ]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                } catch (error) {
                    alert('Error al buscar puntos. Por favor intente nuevamente.');
                    console.error('Error:', error);
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Buscar puntos cercanos';
                }
            });

            // Funci√≥n para calcular distancia entre dos puntos (f√≥rmula de Haversine)
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radio de la Tierra en km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            // Cancelar b√∫squeda de residuos
            // Cancelar b√∫squeda de residuos
            document.getElementById('cancel-waste-search-btn').addEventListener('click', () => {
                document.getElementById('waste-type-search').value = '';
                document.getElementById('waste-location-selected').style.display = 'none';
                document.getElementById('waste-results').style.display = 'none';
                document.getElementById('search-waste-points-btn').disabled = true;
                document.getElementById('waste-search-location-btn').textContent = 'üìç Obtener mi ubicaci√≥n';
                
                if (wasteSearchMarker) {
                    map.removeLayer(wasteSearchMarker);
                    wasteSearchMarker = null;
                }
                wasteSearchLocation = null;

                // Limpiar marcadores de puntos
                wastePointMarkers.forEach(m => map.removeLayer(m));
                wastePointMarkers = [];

                // Cerrar sub-panel de tengo residuos
                const wasteContent = document.getElementById('waste-disposal-content');
                const wasteIcon = document.getElementById('waste-disposal-toggle-icon');
                wasteContent.classList.remove('expanded');
                wasteIcon.classList.add('collapsed');
            });
        }
    </script>
</body>
</html>
